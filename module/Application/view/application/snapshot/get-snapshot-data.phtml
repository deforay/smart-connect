<?php
$testType = (isset($params['testType']) && !empty($params['testType'])) ? $params['testType'] : ["vl", "eid", "covid19"];
$testTypeValue = "for " . implode(",", $testType);
?>
<div class="row">
    <div class="col-md-12 col-sm-6">
        <div class="portlet box blue">
            <div class="portlet-title">
                <div class="caption">
                    <span class="caption-subject"><?php echo $this->translate('Overall Snapshot status ') . strtoupper($testTypeValue); ?></span>
                </div>
            </div>
            <div class="portlet-body">
                <div id="overallSnapshotStatus" style="min-width: 310px; height: 420px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="portlet box blue">
            <div class="portlet-title">
                <div class="caption">
                    <span class="caption-subject"><?php echo $this->translate('Facility Performance'); ?></span>
                </div>
                <div class="actions pull-right" style="padding-top:6px;">
                    <div class="btn-group">
                        <select id="facilityPerformanceDimension" class="form-control input-sm">
                            <option value="testing_lab"><?php echo $this->translate('Testing Lab'); ?></option>
                            <option value="health_facility"><?php echo $this->translate('Health Facility'); ?></option>
                        </select>
                    </div>
                    <div class="btn-group" style="margin-left:5px;">
                        <select id="facilityPerformanceTopN" class="form-control input-sm">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="portlet-body">
                <ul class="nav nav-pills" id="facilityPerformanceModes" style="margin-bottom:15px;">
                    <li class="active"><a href="#" data-mode="backlog"><?php echo $this->translate('Backlog'); ?></a></li>
                    <li><a href="#" data-mode="pct_tested"><?php echo $this->translate('% Tested'); ?></a></li>
                    <li><a href="#" data-mode="volume"><?php echo $this->translate('Volume'); ?></a></li>
                </ul>
                <div id="facilityPerformanceHelp" class="text-muted" style="margin-bottom:10px; display:none;"></div>
                <div id="facilityPerformanceChart" style="height:520px;"></div>
                <div id="facilityPerformanceDual" class="row" style="display:none;">
                    <div class="col-md-6">
                        <h5 class="text-muted" style="margin-top:0;"><?php echo $this->translate('Lowest % Tested'); ?></h5>
                        <div id="facilityPerformanceChartWorst" style="height:520px;"></div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-muted" style="margin-top:0;"><?php echo $this->translate('Highest % Tested'); ?></h5>
                        <div id="facilityPerformanceChartBest" style="height:520px;"></div>
                    </div>
                </div>
                <div id="facilityPerformanceSummary" class="text-muted" style="display:none;margin-top:8px;"></div>
                <div id="facilityPerformanceEmpty" class="text-center text-muted" style="display:none;padding:10px;"><?php echo $this->translate('No data available for the selected filters'); ?></div>
            </div>
        </div>
    </div>
</div>

<table id="regTable" class="table portlet-body table-striped table-bordered table-hover table-checkable order-column">
    <thead>
        <tr>
            <th style="width:40%;text-align:left;"><?php echo $this->translate('Facility'); ?></th>
            <th style="width:20%;text-align:center;"><?php echo $this->translate('Samples Received'); ?></th>
            <th style="width:20%;text-align:center;"><?php echo $this->translate('Samples Tested'); ?></th>
            <th style="width:20%;text-align:center;"><?php echo $this->translate('Samples Rejected'); ?></th>
        </tr>
    </thead>
    <tbody>
        <?php
        $rtotal = $ttotal = $rjtotal = $pjtotal = 0;
        if (isset($result) && !empty($result)) {
            foreach ($result as $val) { ?>
                <tr>
                    <td style="width:40%;text-align:left;"><?php echo $val['clinicName']; ?></td>
                    <td style="width:20%;text-align:center;"><?php echo $val['totalReceived']; ?></td>
                    <td style="width:20%;text-align:center;"><?php echo $val['totalTested']; ?></td>
                    <td style="width:20%;text-align:center;"><?php echo $val['totalRejected']; ?></td>
                </tr>
            <?php $rtotal += $val['totalReceived'];
                $ttotal += $val['totalTested'];
                $rjtotal += $val['totalRejected'];
                $pjtotal += $val['totalPending'];
            }
        } ?>
    </tbody>
    <?php if (isset($result) && !empty($result)) { ?>
        <tfoot>
            <tr>
                <td style="width:40%;font-weight:bold;text-align:right;">Total</td>
                <td style="width:20%;font-weight:bold;text-align:center;"><?php echo $rtotal; ?></td>
                <td style="width:20%;font-weight:bold;text-align:center;"><?php echo $ttotal; ?></td>
                <td style="width:20%;font-weight:bold;text-align:center;"><?php echo $rjtotal; ?></td>
            </tr>
        </tfoot>
    <?php } ?>
</table>
<script>
    (function($) {
        var facilityPerformanceState = {
            mode: 'backlog',
            dimension: 'testing_lab',
            topN: 10,
            data: null,
            chart: null,
            chartWorst: null,
            chartBest: null,
            others: null
        };
        var facilityTableReady = false;
        var pendingFacilityFilter = null;

        window.onFacilityTableReady = function() {
            facilityTableReady = true;
            if (pendingFacilityFilter) {
                applyFacilityTableFilter(pendingFacilityFilter);
                pendingFacilityFilter = null;
            }
        };

        function buildFacilityFilters() {
            return {
                collectionDate: $('#collectionDate').val(),
                testedDate: $('#testedDate').val(),
                testType: $('#testType').val(),
                provinceName: $('#provinceName').val(),
                districtName: $('#districtName').val(),
                clinicId: $('#clinicId').val(),
                labId: $('#labId').val(),
                flag: '<?php echo isset($params['flag']) ? $params['flag'] : ''; ?>'
            };
        }

        function fetchFacilityPerformance() {
            $('#facilityPerformanceEmpty').hide();
            $('#facilityPerformanceChart').html('<div class="text-center" style="padding:15px;"><?php echo $this->translate('Loading facility performance'); ?>...</div>');
            return $.ajax({
                url: "<?php echo $this->url('snapshot', ['action' => 'get-facility-performance']); ?>",
                type: 'POST',
                dataType: 'json',
                data: $.extend(buildFacilityFilters(), {
                    dimension: facilityPerformanceState.dimension,
                    topN: facilityPerformanceState.topN,
                    mode: facilityPerformanceState.mode
                })
            }).done(function(response) {
                facilityPerformanceState.data = response || {
                    perFacility: [],
                    totals: {},
                    others: null
                };
                facilityPerformanceState.others = response && response.others ? response.others : null;
                renderFacilityChart();
            }).fail(function() {
                $('#facilityPerformanceChart').html('<div class="text-center text-danger" style="padding:15px;"><?php echo $this->translate('Unable to load facility performance data.'); ?></div>');
            });
        }

        function renderFacilityChart() {
            var data = facilityPerformanceState.data || {};
            var facilities = data.perFacility || [];
            var chartContainer = $('#facilityPerformanceChart');
            var dualContainer = $('#facilityPerformanceDual');
            chartContainer.empty();
            $('#facilityPerformanceChartWorst, #facilityPerformanceChartBest').empty();
            if (facilityPerformanceState.chart) {
                facilityPerformanceState.chart.destroy();
                facilityPerformanceState.chart = null;
            }
            if (facilityPerformanceState.chartWorst) {
                facilityPerformanceState.chartWorst.destroy();
                facilityPerformanceState.chartWorst = null;
            }
            if (facilityPerformanceState.chartBest) {
                facilityPerformanceState.chartBest.destroy();
                facilityPerformanceState.chartBest = null;
            }

            if (!facilities.length) {
                $('#facilityPerformanceEmpty').show();
                return;
            }
            $('#facilityPerformanceEmpty').hide();

            var mode = facilityPerformanceState.mode;
            var topN = facilityPerformanceState.topN;
            var categories = [];
            var series = [];
            var tooltipFormatter;
            var plotLines = [];
            var stacking = null;
            var othersSummary = null;
            var barCount = 0;
            var helpText = '';
            var overallPct = null;
            var othersFromApi = facilityPerformanceState.others;
            var dualMode = false;

            if (mode === 'backlog') {
                var sorted = facilities.slice().sort(function(a, b) {
                    return (b.pending || 0) - (a.pending || 0);
                });
                var top = sorted.slice(0, topN);
                othersSummary = buildOthersSummary(sorted, topN, 'pending', true, othersFromApi);
                categories = top.map(function(item) {
                    return item.name;
                });
                var testedSeries = top.map(function(item) {
                    return {
                        y: item.tested || 0,
                        facilityId: item.id,
                        facilityName: item.name,
                        received: item.received || 0,
                        tested: item.tested || 0,
                        rejected: item.rejected || 0,
                        pending: item.pending || 0,
                        pctTested: item.pct_tested || 0
                    };
                });
                var pendingSeries = top.map(function(item) {
                    return {
                        y: item.pending || 0,
                        facilityId: item.id,
                        facilityName: item.name,
                        received: item.received || 0,
                        tested: item.tested || 0,
                        rejected: item.rejected || 0,
                        pending: item.pending || 0,
                        pctTested: item.pct_tested || 0
                    };
                });
                stacking = 'normal';
                series = [{
                    name: '<?php echo $this->translate('Tested'); ?>',
                    data: testedSeries,
                    color: '#4CAF50'
                }, {
                    name: '<?php echo $this->translate('Pending'); ?>',
                    data: pendingSeries,
                    color: '#FFD55A'
                }];
                tooltipFormatter = function() {
                    var p = this.point;
                    return '<b>' + p.facilityName + '</b><br/>' +
                        '<?php echo $this->translate('Received'); ?>: ' + Highcharts.numberFormat(p.received || 0, 0) + '<br/>' +
                        '<?php echo $this->translate('Tested'); ?>: ' + Highcharts.numberFormat(p.tested || 0, 0) + '<br/>' +
                        '<?php echo $this->translate('Pending'); ?>: ' + Highcharts.numberFormat(p.pending || 0, 0) + '<br/>' +
                        '<?php echo $this->translate('Rejected'); ?>: ' + Highcharts.numberFormat(p.rejected || 0, 0) + '<br/>' +
                        '<?php echo $this->translate('% Tested'); ?>: ' + Highcharts.numberFormat(p.pctTested || 0, 2) + '%';
                };
            } else if (mode === 'pct_tested') {
                var filtered = facilities.filter(function(item) {
                    return (item.received || 0) > 0;
                }).sort(function(a, b) {
                    return (a.pct_tested || 0) - (b.pct_tested || 0);
                });
                var pctTop = filtered.slice(0, topN);
                var bestTop = filtered.slice(Math.max(filtered.length - topN, 0));
                // enable dual mode only if there are more than topN facilities; otherwise reuse the same list
                dualMode = filtered.length > topN;
                if (!dualMode) {
                    bestTop = pctTop;
                }
                bestTop = bestTop.slice().sort(function(a, b) {
                    return (b.pct_tested || 0) - (a.pct_tested || 0);
                });
                othersSummary = buildOthersSummary(filtered, topN, 'pct_tested', false, othersFromApi);
                categories = pctTop.map(function(item) {
                    return item.name;
                });
                var bestCategories = bestTop.map(function(item) {
                    return item.name;
                });
                var buildPctSeries = function(list) {
                    return [{
                        name: '<?php echo $this->translate('% Tested'); ?>',
                        data: list.map(function(item) {
                            return {
                                y: item.pct_tested || 0,
                                facilityId: item.id,
                                facilityName: item.name,
                                received: item.received || 0,
                                tested: item.tested || 0,
                                rejected: item.rejected || 0,
                                pending: item.pending || 0,
                                pctTested: item.pct_tested || 0
                            };
                        }),
                        color: '#039BE6'
                    }];
                };
                var worstSeries = buildPctSeries(pctTop);
                var bestSeries = buildPctSeries(bestTop);
                series = worstSeries;
                overallPct = data.totals && typeof data.totals.overall_pct_tested !== 'undefined' ? parseFloat(data.totals.overall_pct_tested) : null;
                if (!isNaN(overallPct)) {
                    plotLines.push({
                        color: '#f15c80',
                        width: 2,
                        value: overallPct,
                        zIndex: 5,
                        label: {
                            text: Highcharts.numberFormat(overallPct, 1) + '%',
                            align: 'left',
                            x: 5,
                            y: -10,
                            style: {
                                color: '#f15c80'
                            }
                        }
                    });
                }
                tooltipFormatter = function() {
                    var p = this.point;
                    return '<b>' + p.facilityName + '</b><br/>' +
                        '<?php echo $this->translate('% Tested'); ?>: ' + Highcharts.numberFormat(p.pctTested || 0, 2) + '%<br/>' +
                        '<?php echo $this->translate('Received'); ?>: ' + Highcharts.numberFormat(p.received || 0, 0) + '<br/>' +
                        '<?php echo $this->translate('Tested'); ?>: ' + Highcharts.numberFormat(p.tested || 0, 0);
                };
                helpText = '<?php echo $this->translate('% of received samples that are tested (facilities with 0 received are hidden)'); ?>';
                if (!isNaN(overallPct)) {
                    helpText += '. <?php echo $this->translate('Pink line = overall % tested'); ?>: ' + Highcharts.numberFormat(overallPct, 1) + '%';
                }
            } else {
                var volumeSorted = facilities.slice().sort(function(a, b) {
                    return (b.received || 0) - (a.received || 0);
                });
                var volumeTop = volumeSorted.slice(0, topN);
                othersSummary = buildOthersSummary(volumeSorted, topN, 'received', true, othersFromApi);
                categories = volumeTop.map(function(item) {
                    return item.name;
                });
                series = [{
                    name: '<?php echo $this->translate('Received'); ?>',
                    data: volumeTop.map(function(item) {
                        return {
                            y: item.received || 0,
                            facilityId: item.id,
                            facilityName: item.name,
                            received: item.received || 0,
                            tested: item.tested || 0,
                            rejected: item.rejected || 0,
                            pending: item.pending || 0,
                            pctTested: item.pct_tested || 0
                        };
                    }),
                    color: '#7cb5ec'
                }];
                tooltipFormatter = function() {
                    var p = this.point;
                    return '<b>' + p.facilityName + '</b><br/>' +
                        '<?php echo $this->translate('Received'); ?>: ' + Highcharts.numberFormat(p.received || 0, 0) + '<br/>' +
                        '<?php echo $this->translate('Tested'); ?>: ' + Highcharts.numberFormat(p.tested || 0, 0) + '<br/>' +
                        '<?php echo $this->translate('Pending'); ?>: ' + Highcharts.numberFormat(p.pending || 0, 0) + '<br/>' +
                        '<?php echo $this->translate('% Tested'); ?>: ' + Highcharts.numberFormat(p.pctTested || 0, 2) + '%';
                };
            }

            barCount = categories.length;
            var dynamicHeight = Math.max(320, (barCount * 38) + 160);
            chartContainer.height(dynamicHeight);
            $('#facilityPerformanceChartWorst, #facilityPerformanceChartBest').height(dynamicHeight);
            var helpEl = $('#facilityPerformanceHelp');
            if (helpText) {
                helpEl.text(helpText).show();
            } else {
                helpEl.hide().text('');
            }

            var chartOptionsBase = function(localCategories, localSeries) {
                return {
                    chart: {
                        type: 'bar',
                        spacing: [10, 20, 10, 20],
                        marginLeft: 260
                    },
                    title: {
                        text: ''
                    },
                    credits: {
                        enabled: false
                    },
                    xAxis: {
                        categories: localCategories,
                        title: {
                            text: null
                        }
                    },
                    yAxis: {
                        min: 0,
                        max: (mode === 'pct_tested') ? 100 : null,
                        tickInterval: (mode === 'pct_tested') ? 10 : null,
                        title: {
                            text: (mode === 'pct_tested') ? '<?php echo $this->translate('% Tested'); ?>' : '<?php echo $this->translate('Samples'); ?>'
                        },
                        plotLines: plotLines
                    },
                    tooltip: {
                        useHTML: true,
                        formatter: tooltipFormatter
                    },
                    plotOptions: {
                        series: {
                            stacking: stacking,
                            cursor: 'pointer',
                            point: {
                                events: {
                                    click: function() {
                                        if (this.options && this.options.isOther) {
                                            return;
                                        }
                                        handleFacilityBarClick(this.options);
                                    }
                                }
                            },
                            dataLabels: {
                                enabled: true,
                                formatter: function() {
                                    if (mode === 'pct_tested') {
                                        var p = this.point;
                                        return Highcharts.numberFormat(p.pctTested || 0, 1) + '% (' +
                                            Highcharts.numberFormat(p.tested || 0, 0) + '/' +
                                            Highcharts.numberFormat(p.received || 0, 0) + ')';
                                    }
                                    var total = (this.point.tested || 0) + (this.point.pending || 0);
                                    if (mode === 'backlog') {
                                        if (this.y < 50 || (total > 0 && (this.y / total) < 0.02)) {
                                            return null;
                                        }
                                    }
                                    if (mode === 'volume' && this.y < 50) {
                                        return null;
                                    }
                                    return Highcharts.numberFormat(this.y, 0);
                                }
                            }
                        }
                    },
                    legend: {
                        enabled: localSeries.length > 1
                    },
                    series: localSeries
                };
            };

            if (dualMode) {
                dualContainer.show();
                $('#facilityPerformanceChart').hide();
                facilityPerformanceState.chartWorst = Highcharts.chart('facilityPerformanceChartWorst', chartOptionsBase(categories, worstSeries));
                facilityPerformanceState.chartBest = Highcharts.chart('facilityPerformanceChartBest', chartOptionsBase(bestCategories, bestSeries));
            } else {
                dualContainer.hide();
                $('#facilityPerformanceChart').show();
                facilityPerformanceState.chart = Highcharts.chart('facilityPerformanceChart', chartOptionsBase(categories, series));
            }

            var summaryEl = $('#facilityPerformanceSummary');
            if (othersSummary) {
                summaryEl.show().text('<?php echo $this->translate('Others (aggregated)'); ?>: ' +
                    '<?php echo $this->translate('Received'); ?>: ' + Highcharts.numberFormat(othersSummary.received || 0, 0) + '   ' +
                    '<?php echo $this->translate('Tested'); ?>: ' + Highcharts.numberFormat(othersSummary.tested || 0, 0) + '   ' +
                    '<?php echo $this->translate('Pending'); ?>: ' + Highcharts.numberFormat(othersSummary.pending || 0, 0) + '   ' +
                    '<?php echo $this->translate('Rejected'); ?>: ' + Highcharts.numberFormat(othersSummary.rejected || 0, 0) + '   ' +
                    '<?php echo $this->translate('% Tested'); ?>: ' + Highcharts.numberFormat(othersSummary.pct_tested || 0, 2) + '%');
            } else {
                summaryEl.hide().text('');
            }
        }

        function buildOthersSummary(sortedFacilities, topN, sortKey, allowZeroReceived, apiOthers) {
            var eligible = sortedFacilities.slice();
            if (!allowZeroReceived) {
                eligible = eligible.filter(function(item) {
                    return (item.received || 0) > 0;
                });
            }
            if (eligible.length <= topN) {
                return null;
            }
            if (apiOthers && apiOthers.received !== undefined) {
                return apiOthers;
            }
            var remainder = eligible.slice(topN);
            var summary = {
                received: 0,
                tested: 0,
                rejected: 0,
                pending: 0,
                pct_tested: 0
            };
            remainder.forEach(function(item) {
                summary.received += item.received || 0;
                summary.tested += item.tested || 0;
                summary.rejected += item.rejected || 0;
                summary.pending += item.pending || 0;
            });
            summary.pending = Math.max(0, summary.pending);
            summary.pct_tested = (summary.received > 0) ? (summary.tested * 100 / summary.received) : 0;
            return summary;
        }

        function handleFacilityBarClick(pointOptions) {
            if (!pointOptions || !pointOptions.facilityName) {
                return;
            }
            applyFacilityTableFilter(pointOptions.facilityName);
        }

        function applyFacilityTableFilter(facilityName) {
            if (!facilityName) {
                return;
            }
            if (!facilityTableReady || typeof oTable === 'undefined' || !oTable || !oTable.fnFilter) {
                pendingFacilityFilter = facilityName;
                return;
            }
            var columnIndex = getFacilityColumnIndex();
            if (columnIndex !== null) {
                oTable.fnFilter(facilityName, columnIndex, false, false);
            } else {
                oTable.fnFilter('"' + facilityName + '"');
            }
            if ($('#regTable').length) {
                $('html, body').animate({
                    scrollTop: $('#regTable').offset().top - 60
                }, 400);
            }
        }

        function getFacilityColumnIndex() {
            var index = null;
            $('#regTable thead th').each(function(i) {
                var text = $.trim($(this).text()).toLowerCase();
                if (text.indexOf('facility') !== -1 || text.indexOf('lab') !== -1) {
                    index = i;
                    return false;
                }
            });
            return index;
        }

        function bindFacilityPerformanceControls() {
            $('#facilityPerformanceModes').on('click', 'a', function(e) {
                e.preventDefault();
                var $parent = $(this).parent('li');
                if ($parent.hasClass('active')) {
                    return;
                }
                $('#facilityPerformanceModes li').removeClass('active');
                $parent.addClass('active');
                facilityPerformanceState.mode = $(this).data('mode');
                fetchFacilityPerformance();
            });

            $('#facilityPerformanceDimension').on('change', function() {
                facilityPerformanceState.dimension = $(this).val();
                fetchFacilityPerformance();
            });

            $('#facilityPerformanceTopN').on('change', function() {
                facilityPerformanceState.topN = parseInt($(this).val(), 10) || 10;
                fetchFacilityPerformance();
            });
        }

        bindFacilityPerformanceControls();
        fetchFacilityPerformance();

        $('#overallSnapshotStatus').highcharts({
            chart: {
                type: 'column'
            },
            title: {
                text: ''
            },
            exporting: {
                chartOptions: {
                    subtitle: {
                        text: '<?php echo $this->translate('Overall Snapshot Status'); ?>',
                    }
                }
            },
            credits: {
                enabled: false
            },
            xAxis: {
                categories: ['<?php echo $this->translate('Samples Registered'); ?>',
                    '<?php echo $this->translate('Sample Tested'); ?>',
                    '<?php echo $this->translate('Sample Pending'); ?>',
                    '<?php echo $this->translate('Sample Rejected'); ?>',
                ]
            },
            yAxis: {
                allowDecimals: false,
                min: 0,
                title: {
                    text: '<?php echo $this->translate('No. of Samples'); ?>'
                }
            },
            tooltip: {
                formatter: function() {
                    return '<b>' + this.x + '</b><br/>' +
                        this.series.name + ': ' + this.y + '<br/>' +
                        '<?php echo $this->translate('Total'); ?>: ' + this.point.stackTotal;
                }
            },
            plotOptions: {
                column: {
                    stacking: 'normal',
                    dataLabels: {
                        enabled: true
                    },
                    enableMouseTracking: false
                }
            },
            series: [{
                name: '<?php echo $this->translate('Sample'); ?>',
                showInLegend: false,
                data: [{
                        y: <?php echo (isset($rtotal)) ? $rtotal : 0; ?>,
                        color: 'gray'
                    },
                    {
                        y: <?php echo (isset($ttotal)) ? $ttotal : 0; ?>,
                        color: '#039BE6'
                    },
                    {
                        y: <?php echo (isset($pjtotal)) ? $pjtotal : 0; ?>,
                        color: '#FFD55A'
                    },
                    {
                        y: <?php echo (isset($rjtotal)) ? $rjtotal : 0; ?>,
                        color: '#ff1900'
                    }
                ],
                stack: 'total',
                color: 'red',
            }]
        });
    })(jQuery);
</script>
